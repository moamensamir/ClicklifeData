<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ClicklifeData - إدارة العملاء والأرقام</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7fbff;
      --card:#ffffff;
      --accent:#0b74d1;
      --accent-2:#0ea56a;
      --muted:#6b7280;
      --danger:#e11d48;
      font-family: 'Cairo', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0b1724}
    .container{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    button, .btn{
      background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer;
      box-shadow:0 2px 6px rgba(11,116,209,0.12)
    }
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid rgba(11,116,209,0.12)}
    .btn.ghost{background:transparent;color:var(--accent);border:1px dashed rgba(11,116,209,0.12)}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media(max-width:900px){.layout{grid-template-columns:1fr}}
    .panel{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(12,30,50,0.04)}
    .searchBox{position:relative}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6eef9;font-size:15px}
    .autocomplete{position:absolute;left:0;right:0;top:110%;background:#fff;border:1px solid #e6eef9;border-radius:8px;max-height:220px;overflow:auto;z-index:30}
    .item{padding:10px 12px;border-bottom:1px solid #f0f6fb;cursor:pointer}
    .item:last-child{border-bottom:0}
    .item:hover{background:#f4fbff}
    .customerCard h2{margin:0 0 8px 0;font-size:18px}
    .phones{display:flex;flex-direction:column;gap:8px}
    .phoneRow{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #eef6ff}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;margin-top:12px}
    .small{padding:6px 8px;font-size:13px;border-radius:8px}
    .addFloat{display:flex;gap:8px;align-items:center}
    .footer-note{margin-top:12px;color:var(--muted);font-size:13px}
    .fileInput{display:none}
    .row{display:flex;gap:8px;align-items:center}
    /* modal */
    .modalBackdrop{position:fixed;inset:0;background:rgba(6,18,30,0.4);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:#fff;border-radius:10px;padding:18px;min-width:320px;max-width:520px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="tel"], input[type="text"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef9;margin-bottom:10px}
    .danger{background:var(--danger);color:#fff}
    .small-muted{font-size:13px;color:var(--muted)}
    .empty{color:var(--muted);padding:18px;border-radius:8px;text-align:center}
    .topRow{display:flex;gap:8px;align-items:center}
    .badge{background:#eef8ff;color:var(--accent);padding:6px 8px;border-radius:999px;font-weight:600}
    .btn.green{background:var(--accent-2)}
    .link-like{background:transparent;border:0;color:var(--accent);cursor:pointer;font-weight:600}
    /* responsive phone list */
    .phones-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ClicklifeData — إدارة العملاء والأرقام</h1>
        <div class="small-muted">رفع Excel، بحث أوتوكومبليت، إضافة رقم أو عميل جديد — يعمل بدون سيرفر</div>
      </div>
      <div class="controls">
        <label class="btn" for="filePicker">Upload Excel</label>
        <input id="filePicker" class="fileInput" type="file" accept=".xlsx,.xls" />
        <button id="btnAddCustomer" class="btn secondary">➕ إضافة عميل جديد</button>
        <button id="btnClear" class="btn ghost">مسح البيانات</button>
      </div>
    </header>

    <main class="layout">
      <section class="panel" aria-label="Main panel">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div style="flex:1" class="searchBox">
            <input id="searchInput" type="text" placeholder="اكتب اسم العميل (مثال: ah) للبحث..." autocomplete="off" />
            <div id="autocomplete" class="autocomplete" style="display:none"></div>
          </div>
          <div class="addFloat">
            <button id="btnAddNumber" class="btn green small">➕ Add New Number</button>
          </div>
        </div>

        <div id="mainArea">
          <div class="empty">ابحث عن عميل أو ارفع ملف Excel لبدء الاستخدام</div>
        </div>

        <div class="footer-note">ملاحظة: البيانات تُخزن محلياً على المتصفح. استخدم زر "مسح البيانات" لحذفها.</div>
      </section>

      <aside class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div><strong>عدد العملاء:</strong> <span id="customersCount">0</span></div>
          <div class="badge" id="phonesCount">0 أرقام</div>
        </div>

        <div style="margin-bottom:10px">
          <strong>عينة من البيانات:</strong>
          <div id="sampleList" style="margin-top:8px"></div>
        </div>

        <div style="margin-top:12px">
          <strong>أزرار مفيدة:</strong>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnExport" class="btn secondary small">تصدير JSON</button>
            <button id="btnImportSample" class="btn small">استيراد مثال</button>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- modals -->
  <div id="modalRoot"></div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // بيانات في الذاكرة
    let state = {
      customers: [] // كل عنصر: {id, name, name_norm, phones: [{id, phone, phone_norm}]}
    };

    const LS_KEY = 'clicklife_data_v1';

    // أدوات normalization
    function normName(s){
      return (s||'').toString().normalize('NFKD').replace(/[\u064B-\u0652]/g,'').trim().toLowerCase().replace(/\s+/g,' ');
    }
    function normPhone(p){
      return (p||'').toString().replace(/[^0-9+]/g,'').replace(/^0+/,'0'); // احتفظ بالأرقام و+
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      renderSummary();
    }
    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{
          state = JSON.parse(raw);
        }catch(e){ state = {customers:[]} }
      } else {
        state = {customers:[]};
      }
    }

    // id generator
    function uid(prefix='id'){
      return prefix+'_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8);
    }

    // إضافة/بحث
    function findCustomerByNameNorm(name_norm){
      return state.customers.find(c => c.name_norm === name_norm);
    }
    function addOrGetCustomerByName(name){
      const nn = normName(name);
      let c = findCustomerByNameNorm(nn);
      if(!c){
        c = {id: uid('c'), name: (name||'').toString().trim(), name_norm: nn, phones: []};
        state.customers.push(c);
      } else {
        // update display name if empty or shorter
        if(!c.name && name) c.name = name;
      }
      return c;
    }
    function addPhoneToCustomer(customerId, phone){
      const pnorm = normPhone(phone);
      if(!pnorm) return {ok:false,msg:'رقم غير صالح'};
      const cust = state.customers.find(x=>x.id===customerId);
      if(!cust) return {ok:false, msg:'العميل غير موجود'};
      if(cust.phones.find(p=>p.phone_norm === pnorm)) return {ok:false, msg:'الرقم موجود بالفعل لهذا العميل'};
      const phoneObj = {id: uid('p'), phone: phone.toString().trim(), phone_norm: pnorm};
      cust.phones.push(phoneObj);
      saveState();
      return {ok:true, phone: phoneObj};
    }

    // تحليل Excel (browser)
    function handleFile(file){
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = e.target.result;
        let workbook;
        try {
          workbook = XLSX.read(data, {type:'binary'});
        } catch(err) {
          alert('فشل قراءة الملف. تأكد إنه Excel صحيح.');
          return;
        }
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});
        if(!rows || rows.length === 0) {
          alert('الملف فارغ أو غير مفهوم.');
          return;
        }
        // نحاول التعرّف على الأعمدة: لو الصف الأول يحتوي "name" أو "اسم" و "phone" أو "تليفون"
        let startIdx = 0;
        let colName = 0, colPhone = 1;
        const firstRow = rows[0].map(c=>String(c).trim().toLowerCase());
        if(firstRow.some(x=>x.includes('name') || x.includes('اسم')) && firstRow.some(x=>x.includes('phone') || x.includes('تليفون') || x.includes('mobile'))){
          // نستخدم كـ headers
          colName = firstRow.findIndex(x => x.includes('name') || x.includes('اسم'));
          colPhone = firstRow.findIndex(x => x.includes('phone') || x.includes('تليفون') || x.includes('mobile'));
          startIdx = 1;
        } else {
          // افتراض: الاسم في العمود 0 والرقم في العمود 1
          colName = 0; colPhone = 1; startIdx = 0;
        }

        let added = 0, skipped=0;
        for(let i=startIdx;i<rows.length;i++){
          const row = rows[i];
          const rawName = row[colName]!==undefined ? row[colName] : '';
          const rawPhone = row[colPhone]!==undefined ? row[colPhone] : '';
          if((String(rawName).trim()==='') && (String(rawPhone).trim()==='')) continue;
          const cust = addOrGetCustomerByName(rawName || 'Unknown');
          const res = addPhoneToCustomer(cust.id, rawPhone);
          if(res.ok) added++;
          else skipped++;
        }
        saveState();
        alert('تم الاستيراد: ' + added + ' أرقام مضافة. تخطيت: ' + skipped);
        renderMainEmpty(); // force render
      };
      reader.readAsBinaryString(file);
    }

    // UI rendering
    function el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      for(const k in attrs){
        if(k==='html') e.innerHTML = attrs[k];
        else if(k==='on') { for(const ev in attrs[k]) e.addEventListener(ev, attrs[k][ev]); }
        else e.setAttribute(k, attrs[k]);
      }
      (Array.isArray(children)?children:[children]).forEach(ch=>{
        if(!ch) return;
        if(typeof ch === 'string') e.appendChild(document.createTextNode(ch));
        else e.appendChild(ch);
      });
      return e;
    }

    function renderSummary(){
      const customersCount = state.customers.length;
      const phonesCount = state.customers.reduce((s,c)=>s + (c.phones?.length||0),0);
      document.getElementById('customersCount').textContent = customersCount;
      document.getElementById('phonesCount').textContent = phonesCount + ' أرقام';
      const sample = document.getElementById('sampleList');
      sample.innerHTML = '';
      const sampleItems = state.customers.slice(0,6);
      if(sampleItems.length===0){
        sample.innerHTML = '<div class="small-muted">لا توجد بيانات بعد</div>';
      } else {
        sampleItems.forEach(c=>{
          const div = el('div',{style:'padding:6px 0;border-bottom:1px dashed #f3f9ff'}, [
            el('div', {html: '<strong>' + escapeHtml(c.name) + '</strong>'}),
            el('div', {class:'small-muted', html: (c.phones.map(p=>escapeHtml(p.phone)).slice(0,3).join(' • ') || '<i>لا توجد أرقام</i>')})
          ]);
          sample.appendChild(div);
        });
      }
    }

    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function renderMainEmpty(){
      const area = document.getElementById('mainArea');
      area.innerHTML = '';
      const q = document.getElementById('searchInput').value.trim();
      if(q){
        // find first match and show it if unique exact
      }
      const empty = el('div',{class:'empty'}, 'اختر عميل من الأوتوكومبليت أو اضف عميل جديد.');
      area.appendChild(empty);
    }

    function renderCustomerCard(customer){
      const area = document.getElementById('mainArea');
      area.innerHTML = '';
      const card = el('div',{class:'customerCard'});
      const h = el('h2',{}, customer.name + ' ');
      card.appendChild(h);
      const meta = el('div',{class:'muted'}, 'المعرف: ' + customer.id);
      card.appendChild(meta);

      const phonesWrap = el('div',{class:'phones-grid', style:'margin-top:12px'});
      if((customer.phones||[]).length===0){
        phonesWrap.appendChild(el('div',{class:'empty'}, 'لا توجد أرقام لهذا العميل'));
      } else {
        customer.phones.forEach(ph=>{
          const row = el('div',{class:'phoneRow'}, [
            el('div',{html: '<strong>' + escapeHtml(ph.phone) + '</strong><div class="small-muted">id: ' + ph.id + '</div>'}),
            el('div',{}, [
              el('button',{class:'btn secondary small', on:{click:()=>{navigator.clipboard?.writeText(ph.phone); alert("تم نسخ الرقم: "+ph.phone)}}}, 'نسخ'),
            ])
          ]);
          phonesWrap.appendChild(row);
        });
      }
      card.appendChild(phonesWrap);

      const actions = el('div',{class:'actions'}, [
        el('button',{class:'btn green', on:{click:()=> openAddPhoneModal(customer.id)}}, '➕ Add New Number'),
        el('button',{class:'btn secondary', on:{click:()=>{ if(confirm("هل تريد حذف هذا العميل وكل الأرقام؟")){ deleteCustomer(customer.id); } }}}, 'حذف العميل')
      ]);
      card.appendChild(actions);

      area.appendChild(card);
    }

    function deleteCustomer(customerId){
      state.customers = state.customers.filter(c=>c.id!==customerId);
      saveState();
      document.getElementById('mainArea').innerHTML = '';
      renderMainEmpty();
    }

    // autocomplete
    let autocompleteTimer = null;
    function updateAutocomplete(){
      const q = document.getElementById('searchInput').value.trim();
      const box = document.getElementById('autocomplete');
      if(!q){ box.style.display='none'; return; }
      const qn = normName(q);
      const matches = state.customers.filter(c => c.name_norm.includes(qn)).slice(0,20);
      if(matches.length===0){ box.style.display='none'; return; }
      box.innerHTML = '';
      matches.forEach(c=>{
        const it = el('div',{class:'item', on:{click:()=>{ document.getElementById('searchInput').value = c.name; box.style.display='none'; renderCustomerCard(c); }}}, [
          el('div',{html: '<strong>' + escapeHtml(c.name) + '</strong>'}),
          el('div',{class:'small-muted', html: (c.phones.map(p=>escapeHtml(p.phone)).slice(0,3).join(' • ') || 'لا أرقام')})
        ]);
        box.appendChild(it);
      });
      box.style.display='block';
    }

    // modals
    function openModal(contentNode){
      const root = document.getElementById('modalRoot');
      const backdrop = el('div',{class:'modalBackdrop'});
      const box = el('div',{class:'modal'});
      box.appendChild(contentNode);
      backdrop.appendChild(box);
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop){ closeModal(); }});
      root.appendChild(backdrop);
    }
    function closeModal(){
      const root = document.getElementById('modalRoot');
      root.innerHTML = '';
    }

    function openAddCustomerModal(prefillName='', prefillPhone=''){
      const content = el('div',{}, [
        el('h3',{html:'إضافة عميل جديد'}),
        el('label',{}, 'اسم العميل'),
        el('input',{type:'text', id:'newCustomerName', value:prefillName}),
        el('label',{}, 'رقم التليفون (أول رقم)'),
        el('input',{type:'tel', id:'newCustomerPhone', value:prefillPhone}),
        el('div',{class:'row'}, [
          el('button',{class:'btn', on:{click:()=> {
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.trim();
            if(!name){ alert('اكتب اسم العميل'); return; }
            const c = addOrGetCustomerByName(name);
            const addRes = addPhoneToCustomer(c.id, phone);
            if(!addRes.ok && phone) { alert(addRes.msg); return; }
            saveState();
            closeModal();
            renderCustomerCard(c);
          }}}, 'Save'),
          el('button',{class:'btn secondary', on:{click:()=>closeModal()}}, 'Cancel')
        ])
      ]);
      openModal(content);
    }

    function openAddPhoneModal(customerId){
      // build select of customers (simple)
      const content = el('div',{}, [
        el('h3',{html:'Add New Number'}),
        el('label',{}, 'اختر العميل'),
        (()=>{ const sel = el('select',{id:'selectCustomer'}); state.customers.forEach(c=> sel.appendChild(el('option',{value:c.id, html:c.name}))); sel.value = customerId || (state.customers[0]?state.customers[0].id:''); return sel })(),
        el('label',{}, 'New Phone Number'),
        el('input',{type:'tel', id:'inputNewPhone'}),
        el('div',{class:'row'}, [
          el('button',{class:'btn', on:{click:()=>{
            const cid = document.getElementById('selectCustomer').value;
            const phone = document.getElementById('inputNewPhone').value.trim();
            const res = addPhoneToCustomer(cid, phone);
            if(!res.ok) { alert(res.msg); return; }
            closeModal();
            const cust = state.customers.find(c=>c.id===cid);
            renderCustomerCard(cust);
          }}}, 'Done'),
          el('button',{class:'btn secondary', on:{click:()=>closeModal()}}, 'Cancel')
        ])
      ]);
      openModal(content);
    }

    // events
    document.getElementById('filePicker').addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      handleFile(f);
      e.target.value = '';
    });

    document.getElementById('btnAddCustomer').addEventListener('click', ()=> openAddCustomerModal());
    document.getElementById('btnAddNumber').addEventListener('click', ()=> {
      if(state.customers.length===0){ alert('لا يوجد عملاء — أضف عميل أولاً أو استورد ملف Excel'); return; }
      openAddPhoneModal();
    });
    document.getElementById('btnClear').addEventListener('click', ()=> {
      if(confirm('هل تريد مسح كل البيانات المخزنة محلياً؟')){ localStorage.removeItem(LS_KEY); loadState(); renderSummary(); renderMainEmpty(); }
    });

    document.getElementById('searchInput').addEventListener('input', ()=>{
      if(autocompleteTimer) clearTimeout(autocompleteTimer);
      autocompleteTimer = setTimeout(updateAutocomplete, 160);
    });
    document.addEventListener('click', (e)=> {
      const ac = document.getElementById('autocomplete');
      if(!e.target.closest('.searchBox')) ac.style.display='none';
    });

    document.getElementById('btnExport').addEventListener('click', ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'clicklife_export.json'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('btnImportSample').addEventListener('click', ()=>{
      // small sample
      const sample = [
        {name: 'Ahmed Ali', phone: '01012345678'},
        {name: 'Ahmed Ali', phone: '01198765432'},
        {name: 'Mohamed Samir', phone: '01234567890'},
        {name: 'Aisha Ahmed', phone: '01055551234'}
      ];
      sample.forEach(row=>{
        const c = addOrGetCustomerByName(row.name);
        addPhoneToCustomer(c.id, row.phone);
      });
      saveState();
      alert('تم استيراد مثال صغير');
      renderSummary();
    });

    // init
    loadState();
    renderSummary();
    renderMainEmpty();
  </script>
</body>
</html>
