<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ClicklifeData â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…</title>

  <!-- Fonts: Cairo for Arabic text + a friendly "hand" font for headings -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">

  <style>
    :root{
      /* warmer, more human palette */
      --bg: #fbfdff;
      --card: #ffffff;
      --accent: #f59e0b;      /* warm amber */
      --accent-2: #10b981;    /* pleasant green */
      --muted: #6b7280;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.6);

      --radius: 12px;
      --soft-shadow: 0 8px 20px rgba(8,20,36,0.06);
      font-family: 'Cairo', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,#fbfdff 0%, #f3f8fb 100%);color:#0b1724}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{
      font-family: 'Patrick Hand', 'Cairo', sans-serif;
      font-size:22px;margin:0;color:#0b1724;letter-spacing:0.2px;
    }
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .controls{display:flex;gap:10px;align-items:center}
    button, .btn{
      background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:14px;font-weight:700;cursor:pointer;
      box-shadow:0 6px 18px rgba(245,158,11,0.12);transition:transform .12s ease,box-shadow .12s ease;
    }
    button:hover{transform:translateY(-2px)}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid rgba(11,116,209,0.06);box-shadow:none}
    .btn.ghost{background:transparent;color:var(--accent);border:1px dashed rgba(11,116,209,0.06)}
    .layout{display:grid;grid-template-columns:1fr 380px;gap:18px}
    @media(max-width:920px){.layout{grid-template-columns:1fr}}
    .panel{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--soft-shadow)}
    .searchBox{position:relative}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #e8f0ff;font-size:15px;background:linear-gradient(180deg,#fff,#fbfdff)}
    input[type="text"]:focus{outline:none;box-shadow:0 6px 18px rgba(16,185,129,0.06);border-color:var(--accent-2)}
    .autocomplete{position:absolute;left:0;right:0;top:110%;background:#fff;border:1px solid #e9f4ff;border-radius:10px;max-height:260px;overflow:auto;z-index:30}
    .item{padding:10px 12px;border-bottom:1px solid #f7fbff;cursor:pointer;display:flex;gap:10px;align-items:center}
    .item:last-child{border-bottom:0}
    .item:hover{background:linear-gradient(90deg,#fffef8,#fbfdff)}
    .customerCard h2{margin:0 0 8px 0;font-size:18px}
    .phones{display:flex;flex-direction:column;gap:8px}
    .phoneRow{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;border:1px solid #eef6ff;background:linear-gradient(180deg,#ffffff,#fbfdff)}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;margin-top:12px}
    .small{padding:6px 8px;font-size:13px;border-radius:10px}
    .addFloat{display:flex;gap:8px;align-items:center}
    .footer-note{margin-top:12px;color:var(--muted);font-size:13px}
    .fileInput{display:none}
    .row{display:flex;gap:8px;align-items:center}
    /* modal */
    .modalBackdrop{position:fixed;inset:0;background:rgba(6,18,30,0.28);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--card);border-radius:14px;padding:18px;min-width:320px;max-width:540px;box-shadow:var(--soft-shadow)}
    label{display:block;font-weight:700;margin-bottom:6px}
    input[type="tel"], input[type="text"], select{width:100%;padding:10px;border-radius:10px;border:1px solid #eef7fb;margin-bottom:10px;background:#fff}
    .danger{background:var(--danger);color:#fff}
    .small-muted{font-size:13px;color:var(--muted)}
    .empty{color:var(--muted);padding:24px;border-radius:10px;text-align:center;background:linear-gradient(180deg,#ffffff,#fbfdff)}
    .topRow{display:flex;gap:8px;align-items:center}
    .badge{background:#ecfdf5;color:var(--accent-2);padding:6px 10px;border-radius:999px;font-weight:700}
    .btn.green{background:var(--accent-2);box-shadow:0 6px 18px rgba(16,185,129,0.08)}
    .link-like{background:transparent;border:0;color:var(--accent);cursor:pointer;font-weight:700}
    /* responsive phone list */
    .phones-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px}
    /* avatar */
    .avatar{width:42px;height:42px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700;margin-right:8px;flex:0 0 42px}
    /* toast */
    .toast-wrap{position:fixed;right:20px;bottom:20px;z-index:120;display:flex;flex-direction:column;gap:8px}
    .toast{background:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 26px rgba(10,20,30,0.12);border-left:6px solid var(--accent-2);min-width:200px}
    .toast.warn{border-left-color:var(--accent)}
    .toast.err{border-left-color:var(--danger)}
    .meta-small{font-size:12px;color:var(--muted);margin-top:8px}
    footer.site-note{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ClicklifeData â€” Ø¯ÙØªØ±Ùƒ Ø§Ù„Ø¨Ø³ÙŠØ· Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>
        <div class="sub">Ø£Ø¯Ø§Ø© Ù…Ø­Ù„ÙŠØ© Ù„Ø­ÙØ¸ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø³Ø±Ø¹Ø©ØŒ ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Excel â€” Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±.</div>
      </div>
      <div class="controls">
        <label class="btn" for="filePicker">Ø±ÙØ¹ Ù…Ù„Ù Excel</label>
        <input id="filePicker" class="fileInput" type="file" accept=".xlsx,.xls" />
        <button id="btnAddCustomer" class="btn secondary">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        <button id="btnClear" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </header>

    <main class="layout">
      <section class="panel" aria-label="Main panel">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div style="flex:1" class="searchBox">
            <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯)" autocomplete="off" />
            <div id="autocomplete" class="autocomplete" style="display:none"></div>
          </div>
          <div class="addFloat">
            <button id="btnAddNumber" class="btn green small">â• Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù…</button>
          </div>
        </div>

        <div id="mainArea">
          <div class="empty">
            <div style="font-size:16px;font-weight:700;margin-bottom:6px">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
            Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel Ø£Ùˆ Ø£Ø¶Ù Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù„Ø¨Ø¯Ø¡ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹.
          </div>
        </div>

        <div class="footer-note">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ù…ØªØµÙØ­Ùƒ. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ø­Ø°ÙÙ‡Ø§.</div>
      </section>

      <aside class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</strong> <span id="customersCount">0</span></div>
          <div class="badge" id="phonesCount">0 Ø£Ø±Ù‚Ø§Ù…</div>
        </div>

        <div style="margin-bottom:10px">
          <strong>Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong>
          <div id="sampleList" style="margin-top:8px"></div>
          <div id="lastAction" class="meta-small" style="margin-top:8px">Ù„Ù… ØªÙØ¬Ø±Ù Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø¹Ø¯</div>
        </div>

        <div style="margin-top:12px">
          <strong>Ø£Ø²Ø±Ø§Ø± Ù…ÙÙŠØ¯Ø©:</strong>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnExport" class="btn secondary small">ØªØµØ¯ÙŠØ± JSON</button>
            <button id="btnImportSample" class="btn small">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø«Ø§Ù„</button>
          </div>
        </div>

        <footer class="site-note">ØªÙ… ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„ØªÙƒÙˆÙ† Ø¨Ø³ÙŠØ·Ø© ÙˆÙ…Ø±ÙŠØ­Ø© Ù„Ù„Ø¹ÙŠÙ† â€” Ø¥Ù† Ø§Ø­ØªØ¬Øª Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø£Ø®Ø¨Ø±Ù†ÙŠ :)</footer>
      </aside>
    </main>
  </div>

  <!-- modals + toasts -->
  <div id="modalRoot"></div>
  <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    let state = {
      customers: [] // ÙƒÙ„ Ø¹Ù†ØµØ±: {id, name, name_norm, phones: [{id, phone, phone_norm}]}
    };

    const LS_KEY = 'clicklife_data_v1';

    // Ø£Ø¯ÙˆØ§Øª normalization
    function normName(s){
      return (s||'').toString().normalize('NFKD').replace(/[\u064B-\u0652]/g,'').trim().toLowerCase().replace(/\s+/g,' ');
    }
    function normPhone(p){
      return (p||'').toString().replace(/[^0-9+]/g,'').replace(/^0+/,'0'); // Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ùˆ+
    }

    // small toast instead of many alert()
    function showToast(msg, type='ok', timeout=3000){
      const wrap = document.getElementById('toastWrap');
      const t = document.createElement('div');
      t.className = 'toast' + (type==='warn' ? ' warn' : type==='err' ? ' err' : '');
      t.textContent = msg;
      wrap.appendChild(t);
      setTimeout(()=> {
        t.style.opacity = '0';
        t.style.transform = 'translateY(8px)';
        setTimeout(()=> t.remove(), 300);
      }, timeout);
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      renderSummary();
      const now = new Date();
      document.getElementById('lastAction').textContent = 'Ø¢Ø®Ø± Ø­ÙØ¸: ' + now.toLocaleString();
    }
    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{
          state = JSON.parse(raw);
        }catch(e){ state = {customers:[]} }
      } else {
        state = {customers:[]};
      }
    }

    // id generator
    function uid(prefix='id'){
      return prefix+'_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8);
    }

    // deterministic avatar color
    const avatarColors = ['#ef4444','#f97316','#f59e0b','#eab308','#10b981','#06b6d4','#3b82f6','#8b5cf6'];
    function colorFor(text){
      let h=0; for(let i=0;i<text.length;i++) h = (h<<5)-h + text.charCodeAt(i);
      return avatarColors[Math.abs(h) % avatarColors.length];
    }
    function makeAvatarElem(name){
      const initials = (name||'?').split(' ').filter(Boolean).slice(0,2).map(s=>s[0].toUpperCase()).join('');
      const div = document.createElement('div');
      div.className = 'avatar';
      div.style.background = colorFor(name);
      div.textContent = initials || '?';
      return div;
    }

    // Ø¥Ø¶Ø§ÙØ©/Ø¨Ø­Ø«
    function findCustomerByNameNorm(name_norm){
      return state.customers.find(c => c.name_norm === name_norm);
    }
    function addOrGetCustomerByName(name){
      const nn = normName(name);
      let c = findCustomerByNameNorm(nn);
      if(!c){
        c = {id: uid('c'), name: (name||'').toString().trim(), name_norm: nn, phones: []};
        state.customers.push(c);
      } else {
        // update display name if empty or shorter
        if(!c.name && name) c.name = name;
      }
      return c;
    }
    function addPhoneToCustomer(customerId, phone){
      const pnorm = normPhone(phone);
      if(!pnorm) return {ok:false,msg:'Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­'};
      const cust = state.customers.find(x=>x.id===customerId);
      if(!cust) return {ok:false, msg:'Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'};
      if(cust.phones.find(p=>p.phone_norm === pnorm)) return {ok:false, msg:'Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„'};
      const phoneObj = {id: uid('p'), phone: phone.toString().trim(), phone_norm: pnorm};
      cust.phones.push(phoneObj);
      saveState();
      return {ok:true, phone: phoneObj};
    }

    // ØªØ­Ù„ÙŠÙ„ Excel (browser)
    function handleFile(file){
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = e.target.result;
        let workbook;
        try {
          workbook = XLSX.read(data, {type:'binary'});
        } catch(err) {
          showToast('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ› ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Excel ØµØ§Ù„Ø­', 'err');
          return;
        }
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});
        if(!rows || rows.length === 0) {
          showToast('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…', 'warn');
          return;
        }
        // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ù„Ùˆ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ­ØªÙˆÙŠ "name" Ø£Ùˆ "Ø§Ø³Ù…" Ùˆ "phone" Ø£Ùˆ "ØªÙ„ÙŠÙÙˆÙ†"
        let startIdx = 0;
        let colName = 0, colPhone = 1;
        const firstRow = rows[0].map(c=>String(c).trim().toLowerCase());
        if(firstRow.some(x=>x.includes('name') || x.includes('Ø§Ø³Ù…')) && firstRow.some(x=>x.includes('phone') || x.includes('ØªÙ„ÙŠÙÙˆÙ†') || x.includes('mobile'))){
          colName = firstRow.findIndex(x => x.includes('name') || x.includes('Ø§Ø³Ù…'));
          colPhone = firstRow.findIndex(x => x.includes('phone') || x.includes('ØªÙ„ÙŠÙÙˆÙ†') || x.includes('mobile'));
          startIdx = 1;
        } else {
          colName = 0; colPhone = 1; startIdx = 0;
        }

        let added = 0, skipped=0;
        for(let i=startIdx;i<rows.length;i++){
          const row = rows[i];
          const rawName = row[colName]!==undefined ? row[colName] : '';
          const rawPhone = row[colPhone]!==undefined ? row[colPhone] : '';
          if((String(rawName).trim()==='') && (String(rawPhone).trim()==='')) continue;
          const cust = addOrGetCustomerByName(rawName || 'Unknown');
          const res = addPhoneToCustomer(cust.id, rawPhone);
          if(res.ok) added++;
          else skipped++;
        }
        saveState();
        showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù â€” Ø£ÙØ¶ÙŠÙ: ' + added + ' Ø±Ù‚Ù…ØŒ ØªÙ… ØªØ¬Ø§Ù‡Ù„: ' + skipped, 'ok', 4000);
        renderMainEmpty(); // force render
      };
      reader.readAsBinaryString(file);
    }

    // UI rendering helpers
    function el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      for(const k in attrs){
        if(k==='html') e.innerHTML = attrs[k];
        else if(k==='on') { for(const ev in attrs[k]) e.addEventListener(ev, attrs[k][ev]); }
        else e.setAttribute(k, attrs[k]);
      }
      (Array.isArray(children)?children:[children]).forEach(ch=>{
        if(!ch) return;
        if(typeof ch === 'string') e.appendChild(document.createTextNode(ch));
        else e.appendChild(ch);
      });
      return e;
    }

    function renderSummary(){
      const customersCount = state.customers.length;
      const phonesCount = state.customers.reduce((s,c)=>s + (c.phones?.length||0),0);
      document.getElementById('customersCount').textContent = customersCount;
      document.getElementById('phonesCount').textContent = phonesCount + ' Ø£Ø±Ù‚Ø§Ù…';
      const sample = document.getElementById('sampleList');
      sample.innerHTML = '';
      const sampleItems = state.customers.slice(0,6);
      if(sampleItems.length===0){
        sample.innerHTML = '<div class="small-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>';
      } else {
        sampleItems.forEach(c=>{
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.padding = '6px 0';
          row.style.borderBottom = '1px dashed #f3f9ff';

          const av = makeAvatarElem(c.name);
          av.style.marginRight = '10px';
          row.appendChild(av);

          const txt = document.createElement('div');
          txt.innerHTML = '<strong>' + escapeHtml(c.name) + '</strong><div class="small-muted">' + (c.phones.map(p=>escapeHtml(p.phone)).slice(0,3).join(' â€¢ ') || 'Ù„Ø§ Ø£Ø±Ù‚Ø§Ù…') + '</div>';
          row.appendChild(txt);

          sample.appendChild(row);
        });
      }
    }

    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function renderMainEmpty(){
      const area = document.getElementById('mainArea');
      area.innerHTML = '';
      const q = document.getElementById('searchInput').value.trim();
      if(q){
        // show approximate matches if any
        const qn = normName(q);
        const matches = state.customers.filter(c => c.name_norm.includes(qn)).slice(0,8);
        if(matches.length===1){
          renderCustomerCard(matches[0]);
          return;
        } else if(matches.length>1){
          const wrap = el('div',{class:'panel'},[]);
          matches.forEach(c=>{
            const it = el('div',{class:'item', on:{click:()=> renderCustomerCard(c)}}, [
              makeAvatarElem(c.name),
              el('div',{html: '<strong>' + escapeHtml(c.name) + '</strong><div class="small-muted">' + (c.phones.map(p=>escapeHtml(p.phone)).slice(0,3).join(' â€¢ ') || 'Ù„Ø§ Ø£Ø±Ù‚Ø§Ù…') + '</div>'})
            ]);
            wrap.appendChild(it);
          });
          area.appendChild(wrap);
          return;
        }
      }
      const empty = el('div',{class:'empty'}, [
        el('div',{html:'<div style="font-size:16px;font-weight:700;margin-bottom:6px">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….'})
      ]);
      area.appendChild(empty);
    }

    function renderCustomerCard(customer){
      const area = document.getElementById('mainArea');
      area.innerHTML = '';
      const card = el('div',{class:'customerCard'});
      const top = document.createElement('div'); top.style.display='flex'; top.style.alignItems='center'; top.style.gap='12px';
      top.appendChild(makeAvatarElem(customer.name));
      const hwrap = document.createElement('div');
      hwrap.innerHTML = '<h2 style="margin:0">' + escapeHtml(customer.name) + '</h2><div class="small-muted">Ø§Ù„Ù…Ø¹Ø±Ù: ' + customer.id + '</div>';
      top.appendChild(hwrap);
      card.appendChild(top);

      const phonesWrap = el('div',{class:'phones-grid', style:'margin-top:16px'});
      if((customer.phones||[]).length===0){
        phonesWrap.appendChild(el('div',{class:'empty'}, 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„'));
      } else {
        customer.phones.forEach(ph=>{
          const row = el('div',{class:'phoneRow'}, [
            el('div',{html: '<strong>' + escapeHtml(ph.phone) + '</strong><div class="small-muted">id: ' + ph.id + '</div>'}),
            el('div',{}, [
              el('button',{class:'btn secondary small', on:{click:()=>{ navigator.clipboard?.writeText(ph.phone).then(()=> showToast("ØªÙ… Ù†Ø³Ø®: " + ph.phone)); }}}, 'Ù†Ø³Ø®'),
            ])
          ]);
          phonesWrap.appendChild(row);
        });
      }
      card.appendChild(phonesWrap);

      const actions = el('div',{class:'actions'}, [
        el('button',{class:'btn green', on:{click:()=> openAddPhoneModal(customer.id)}}, 'â• Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù…'),
        el('button',{class:'btn secondary', on:{click:()=>{ if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŸ")){ deleteCustomer(customer.id); showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„"); } }}}, 'Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„')
      ]);
      card.appendChild(actions);

      area.appendChild(card);
    }

    function deleteCustomer(customerId){
      state.customers = state.customers.filter(c=>c.id!==customerId);
      saveState();
      document.getElementById('mainArea').innerHTML = '';
      renderMainEmpty();
    }

    // autocomplete
    let autocompleteTimer = null;
    function updateAutocomplete(){
      const q = document.getElementById('searchInput').value.trim();
      const box = document.getElementById('autocomplete');
      if(!q){ box.style.display='none'; return; }
      const qn = normName(q);
      const matches = state.customers.filter(c => c.name_norm.includes(qn)).slice(0,20);
      if(matches.length===0){ box.style.display='none'; return; }
      box.innerHTML = '';
      matches.forEach(c=>{
        const it = el('div',{class:'item', on:{click:()=>{ document.getElementById('searchInput').value = c.name; box.style.display='none'; renderCustomerCard(c); }}}, [
          makeAvatarElem(c.name),
          el('div',{html: '<strong>' + escapeHtml(c.name) + '</strong>'}),
          el('div',{class:'small-muted', html: (c.phones.map(p=>escapeHtml(p.phone)).slice(0,3).join(' â€¢ ') || 'Ù„Ø§ Ø£Ø±Ù‚Ø§Ù…')})
        ]);
        box.appendChild(it);
      });
      box.style.display='block';
    }

    // modals
    function openModal(contentNode){
      const root = document.getElementById('modalRoot');
      const backdrop = el('div',{class:'modalBackdrop'});
      const box = el('div',{class:'modal'});
      box.appendChild(contentNode);
      backdrop.appendChild(box);
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop){ closeModal(); }});
      root.appendChild(backdrop);
    }
    function closeModal(){
      const root = document.getElementById('modalRoot');
      root.innerHTML = '';
    }

    function openAddCustomerModal(prefillName='', prefillPhone=''){
      const content = el('div',{}, [
        el('h3',{html:'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯'}),
        el('label',{}, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„'),
        el('input',{type:'text', id:'newCustomerName', value:prefillName}),
        el('label',{}, 'Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† (Ø£ÙˆÙ„ Ø±Ù‚Ù…)'),
        el('input',{type:'tel', id:'newCustomerPhone', value:prefillPhone}),
        el('div',{class:'row'}, [
          el('button',{class:'btn', on:{click:()=> {
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.trim();
            if(!name){ showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'warn'); return; }
            const c = addOrGetCustomerByName(name);
            const addRes = addPhoneToCustomer(c.id, phone);
            if(!addRes.ok && phone) { showToast(addRes.msg, 'warn'); return; }
            saveState();
            closeModal();
            renderCustomerCard(c);
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ok');
          }}}, 'Ø­ÙØ¸'),
          el('button',{class:'btn secondary', on:{click:()=>closeModal()}}, 'Ø¥Ù„ØºØ§Ø¡')
        ])
      ]);
      openModal(content);
    }

    function openAddPhoneModal(customerId){
      // build select of customers
      const sel = el('select',{id:'selectCustomer'});
      state.customers.forEach(c=> sel.appendChild(el('option',{value:c.id, html:c.name})));
      if(customerId) sel.value = customerId;
      else if(state.customers[0]) sel.value = state.customers[0].id;

      const content = el('div',{}, [
        el('h3',{html:'Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯'}),
        el('label',{}, 'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„'),
        sel,
        el('label',{}, 'Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†'),
        el('input',{type:'tel', id:'inputNewPhone'}),
        el('div',{class:'row'}, [
          el('button',{class:'btn', on:{click:()=>{
            const cid = document.getElementById('selectCustomer').value;
            const phone = document.getElementById('inputNewPhone').value.trim();
            const res = addPhoneToCustomer(cid, phone);
            if(!res.ok) { showToast(res.msg, 'warn'); return; }
            closeModal();
            const cust = state.customers.find(c=>c.id===cid);
            renderCustomerCard(cust);
            showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ù‚Ù…', 'ok');
          }}}, 'ØªÙ…'),
          el('button',{class:'btn secondary', on:{click:()=>closeModal()}}, 'Ø¥Ù„ØºØ§Ø¡')
        ])
      ]);
      openModal(content);
    }

    // events
    document.getElementById('filePicker').addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      handleFile(f);
      e.target.value = '';
    });

    document.getElementById('btnAddCustomer').addEventListener('click', ()=> openAddCustomerModal());
    document.getElementById('btnAddNumber').addEventListener('click', ()=> {
      if(state.customers.length===0){ showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ â€” Ø£Ø¶Ù Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø£Ùˆ Ø§Ø³ØªÙˆØ±Ø¯ Ù…Ù„Ù Excel', 'warn'); return; }
      openAddPhoneModal();
    });
    document.getElementById('btnClear').addEventListener('click', ()=> {
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ØŸ')){ localStorage.removeItem(LS_KEY); loadState(); renderSummary(); renderMainEmpty(); showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'ok'); }
    });

    document.getElementById('searchInput').addEventListener('input', ()=>{
      if(autocompleteTimer) clearTimeout(autocompleteTimer);
      autocompleteTimer = setTimeout(updateAutocomplete, 160);
    });
    document.addEventListener('click', (e)=> {
      const ac = document.getElementById('autocomplete');
      if(!e.target.closest('.searchBox')) ac.style.display='none';
    });

    document.getElementById('btnExport').addEventListener('click', ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'clicklife_export.json'; a.click();
      URL.revokeObjectURL(url);
      showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù JSON', 'ok');
    });

    document.getElementById('btnImportSample').addEventListener('click', ()=>{
      // small sample (friendly)
      const sample = [
        {name: 'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', phone: '01012345678'},
        {name: 'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', phone: '01198765432'},
        {name: 'Ù…Ø­Ù…Ø¯ Ø³Ù…ÙŠØ±', phone: '01234567890'},
        {name: 'Ø¹Ø§Ø¦Ø´Ø© Ø£Ø­Ù…Ø¯', phone: '01055551234'}
      ];
      sample.forEach(row=>{
        const c = addOrGetCustomerByName(row.name);
        addPhoneToCustomer(c.id, row.phone);
      });
      saveState();
      showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø«Ø§Ù„ ØµØºÙŠØ±', 'ok');
      renderSummary();
      renderMainEmpty();
    });

    // init
    loadState();
    renderSummary();
    renderMainEmpty();
  </script>
</body>
</html>
